<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <title>Worker page</title>
    <!-- <script src="https://unpkg.com/node-forge@0.7.0/dist/forge.min.js"></script> -->
    
    <!-- <link rel="stylesheet" href="assets/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
     -->
    
</head>

<body>
    <p>Users: <span id="total-users"></span></p>
    <form>
        <p>
            <label for="UserEmail">User Email:</label><input type="text" id="UserEmail" name="UserEmail">
        </p>
        <p>
            <label for="UserPswd">Password:</label><input type="password" id="UserPswd" name="UserPswd">
        </p>
        <p>
            <label for="ConfirmPswd">Confirm Password:</label><input type="confirm" id="ConfirmPswd" name="ConfirmPswd">
        </p>
        <input type="submit" value="Register">

    </form>
    <span id="statusmsg"></span>
	<!-- <script src="myworker.js"></script> -->
     <script src="socket.io.js"></script>
    <script>
        let socket = null;
        const form = document.querySelector("form");
        form.addEventListener("submit", function(e){
            console.log("Submit");
            e.preventDefault();
             const email = form.UserEmail.value;
             const password = form.UserPswd.value;
             const confirm = form.ConfirmPswd.value;
             if(password === confirm){
                fetch("../register/", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({email,password}) })
                .then(data => data.json())
                .then((res) => {
                    if(res.status == "registered"){
                        form.remove();
                        localStorage.setItem("token",res.token);
                        document.getElementById("statusmsg").textContent = `Token created successfuly! User ID is: ${res.UserID}`
                        initSocket();
                    }else{
                        alert(res.status)
                    }
                    
                });
             }else{
                alert("Passwords not matching")
             }
                    
               
        });
        

        function initSocket(){
            socket = io();
            socket.on('ConnectedUsers', (usersNum) => {
                document.getElementById("total-users").textContent = usersNum;
            });

            socket.emit('createRoom', {
                 
             });
        }

        const token = localStorage.getItem("token") || null;
        if(token){
            fetch("../checktoken/", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({token}) })
                .then(data => data.json())
                .then((res) => {
                    if(res.status == "valid"){
                        form.remove();
                    }
                })
        }
        
    </script>
</body>
</html>